pipeline {
    agent any

  environment {
        NODEJS_HOME = tool 'nodeJs'
        PATH = "${NODEJS_HOME}/bin:${env.PATH}"
    }
    

      stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
    stage('preflight') {
      steps {
        echo sh(returnStdout: true, script: 'env')
        sh 'node -v'
      }
    }
    stage('build') {
      steps {
        sh 'npm --version'
        sh 'git log --reverse -1'
        sh 'npm install'
      }
    }
    stage('test') {
      steps {
        sh 'npm test'
      }
    }

     stage('Containerized Application') {
            steps {
                sh "docker build  -t mansour100/nodeapp:${env.BUILD_NUMBER} ."
                withCredentials([usernamePassword(credentialsId: '1', passwordVariable: 'password', usernameVariable: 'username')]) {
                       sh "docker login -u ${username} -p ${password}"
                       
                       sh "docker push mansour100/nodeapp:${env.BUILD_NUMBER}"

                      }
            }
        }
  

  stage('deploy'){
    steps{
         withCredentials([sshUserPrivateKey(credentialsId: 'ec2', keyFileVariable: 'key', usernameVariable: 'username')]) {
            sh "ssh -o StrictHostKeyChecking=no -i $key ec2-user@18.205.55.190"
            sh "docker pull mansour100/nodeapp:${env.BUILD_NUMBER} "
            withCredentials([usernamePassword(credentialsId: 'database', passwordVariable: 'passwordDb', usernameVariable: 'usernameDb')]) {
                sh "docker run -e DB_PASSWORD=${passwordDb}   -e DB_USERNAME=${usernameDb} -p 3000:3000   mansour100/nodeapp:${env.BUILD_NUMBER}"


                }

                sh "exit"

             }
    }
  }
  stage('Post-Build Actions') {
            steps {
                     mail bcc: '',
                     body: "hi team this result of pipeline Build URL:( ${env.BUILD_URL})  Git Commit: ${env.GIT_COMMIT}" ,
                       cc: '', from: '', replyTo: '',
                       subject: "Jenkins Build ${env.JOB_NAME} #${env.BUILD_NUMBER}" , 
                        to: 'benahmedmansour89@gmail.com'
            }
        }


    }

    post {
        always {
          
            cleanWs()
        }


}
}


